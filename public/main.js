let selected,messaging,addModal,deleteModal,auth;const db=firebase.firestore(),releasesRef=db.collection("releases");var ui=new firebaseui.auth.AuthUI(firebase.auth());const server="https://us-central1-snickbox-203303.cloudfunctions.net";function registerSW(){"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then(e=>{console.log("SW registered: ",e),firebase.messaging().useServiceWorker(e)}).catch(e=>{console.log("SW registration failed: ",e)})}function displayLastRecord(e){document.querySelector("#cases").innerHTML=e.cases.positive,document.querySelector("#date").innerHTML=new Date(1e3*e.date).toLocaleDateString("en-US"),document.querySelector("#updateNum").innerHTML=e.id}function displayMedia(e){let t="";for(let n of e)t+=`\n        <div class="card">\n            <div class="card-content black-text">\n                <span class="card-title">Update #: ${n.id}</span>\n                <p>Date: ${new Date(1e3*n.date).toLocaleDateString("en-US")}</p>\n                <p>Tested: ${n.tested}</p>\n                <p>Current Positive Cases: ${n.cases.positive}</p>\n                <p>Total Deaths Cases: ${n.cases.deaths}</p>\n                <p>Total Discharged: ${n.cases.discharged}</p>\n                <p>Deaths: ${n.cases.deaths}</p>\n            </div>\n            <div class="card-action">\n                <a href="${n.url}" rel="noopener" target="_blank" style="font-weight: 700" class="red-text darken-2">View on Facebook</a>\n                <a href="#deleteModal" class="modal-trigger red-text darken-2" onclick="selected = ${n.id}" style="font-weight: 700">Delete</a>\n            </div>\n        </div>\n        `;document.querySelector("#media-list").innerHTML=t}function fixAccessbility(){let e=document.querySelector(".highslide-container>img");e.setAttribute("alt","highslide container image"),e.setAttribute("aria-hidden",!0)}async function postData(e,t){try{return(await fetch(e,{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}})).json()}catch(e){return e}}function deleteData(){getData()}async function createReport(e){e.preventDefault();let t=e.target.elements,n={id:t.updateNum.value,url:t.url.value,date:t.date.value,cases:{deaths:t.deaths.value,positive:t.positive.value,discharged:t.discharged.value},notify:t.notify.value,tested:t.tested.value};const a=await db.collection("releases").doc(n.id).set(n);console.log(n.id,a)}function deleteReport(e){console.log(selected),e.preventDefault();let t=e.target.elements;deleteData({id:selected,password:t.password})}async function getData(){const e=await releasesRef.get();let t=[];e.forEach(e=>{t.push(e.data())}),displayLineChart(t);let n=t.reverse()[0];displayMedia(t),displayPieChart(n),displayLastRecord(n)}async function requestNotifications(){try{await messaging.requestPermission();const e=await messaging.getToken();localStorage.setItem("covid-token",e);let t=await postData(`${server}/subscribe`,{token:e});console.log(e,t),toast("Notifications Enabled!")}catch(e){console.error(e)}}async function tokenRefresh(){try{const e=await messaging.getToken();localStorage.set("covid-token",e)}catch(e){console.log("Unable to retrieve refreshed token ",err)}}async function deleteToken(){const e=await messaging.getToken();messaging.deleteToken(e),localStorage.removeItem("covid-token"),toast("Notifications Disabled!")}function toggleMsg(e){e.target.checked?requestNotifications():deleteToken()}async function checkAlertStatus(){document.querySelector("#msgEnabled").checked=null!==localStorage.getItem("covid-token")}async function foregroundMsg(e){console.log("Message: ",e)}function login(e){ui.start("#authContainer",{callbacks:{signInSuccessWithAuthResult:function(e,t){auth=e,loginModal.close()}},signInFlow:"popup",signInSuccessUrl:"#",signInOptions:[firebase.auth.GoogleAuthProvider.PROVIDER_ID],tosUrl:"https://covid19tt.web.app",privacyPolicyUrl:"https://covid19tt.web.app"})}function getAuth(){firebase.auth().onAuthStateChanged(function(e){e?(auth=e,console.log("logged in")):console.log("not logged in")})}function toast(e){M.toast({html:e})}function main(){(messaging=firebase.messaging()).usePublicVapidKey("BAqoB57ExCmPU2hHer0NWSqTsHgAABG78b0IB_KkAqfAg63k9MG8Q8vqXETs0wDcBckFbsTUs191L39nW7M-EsU"),messaging.onTokenRefresh(tokenRefresh),messaging.onMessage(foregroundMsg),document.querySelector("#msgEnabled").addEventListener("click",toggleMsg),document.querySelector("#loginBtn").addEventListener("click",login),document.forms.createForm.addEventListener("submit",createReport),document.forms.deleteForm.addEventListener("submit",deleteReport),getAuth(),getData(),fixAccessbility(),registerSW(),checkAlertStatus()}addModal=M.Modal.init(document.querySelector("#addModal")),deleteModal=M.Modal.init(document.querySelector("#deleteModal"),{onOpenStart:function(){document.querySelector("#selected").innerHTML=selected}}),loginModal=M.Modal.init(document.querySelector("#loginModal"),{onOpenStart:login}),M.Tabs.init(document.querySelector(".tabs")),window.addEventListener("load",main);