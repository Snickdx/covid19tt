let selected,messaging,addModal,deleteModal,auth;const db=firebase.firestore(),releasesRef=db.collection("releases");var ui=new firebaseui.auth.AuthUI(firebase.auth());const server="https://us-central1-snickbox-203303.cloudfunctions.net";function registerSW(){"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then(e=>{console.log("SW registered: ",e),firebase.messaging().useServiceWorker(e)}).catch(e=>{console.log("SW registration failed: ",e)})}function displayLastRecord(e){document.querySelector("#cases").innerHTML=e.cases.positive,document.querySelector("#date").innerHTML=new Date(1e3*e.date).toLocaleDateString("en-US"),document.querySelector("#updateNum").innerHTML=e.id}function displayMedia(e){let t="";for(let o of e)t+=`\n        <div class="card">\n            <div class="card-content black-text">\n                <span class="card-title">Update #: ${o.id}</span>\n                <p>Date: ${new Date(1e3*o.date).toLocaleDateString("en-US")}</p>\n                <p>Tested: ${o.tested}</p>\n                <p>Current Positive Cases: ${o.cases.positive}</p>\n                <p>Total Deaths Cases: ${o.cases.deaths}</p>\n                <p>Total Discharged: ${o.cases.discharged}</p>\n                <p>Deaths: ${o.cases.deaths}</p>\n            </div>\n            <div class="card-action">\n                <a href="${o.url}" rel="noopener" target="_blank" style="font-weight: 700" class="red-text darken-2">View on Facebook</a>\n                <a href="#" class="deleteBtn red-text darken-2" onclick="deleteData(${o.id})" style="font-weight: 700; display:${auth?"block":"none"}">Delete</a>\n            </div>\n        </div>\n        `;document.querySelector("#media-list").innerHTML=t}function fixAccessbility(){let e=document.querySelector(".highslide-container>img");e.setAttribute("alt","highslide container image"),e.setAttribute("aria-hidden",!0)}async function postData(e,t){try{return(await fetch(e,{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}})).json()}catch(e){return e}}async function deleteData(e){try{const t=await db.collection("releases").doc(""+e).delete();console.log(e,t),toast("Report Deleted!")}catch(e){toast("Error: Insufficient Permissions"),console.log(e)}}async function createReport(e){e.preventDefault();let t=e.target.elements,o={id:parseInt(t.updateNum.value),url:t.url.value,date:Math.floor(new Date(t.date.value).getTime()/1e3),cases:{deaths:parseInt(t.deaths.value),positive:parseInt(t.positive.value),discharged:parseInt(t.discharged.value)},notify:"on"===t.notify.value,tested:parseInt(t.tested.value)};try{const e=await db.collection("releases").doc(""+o.id).set(o);console.log(o.id,e),toast("Report Added!")}catch(e){toast("Error: Insufficient Permissions")}}async function displayData(e){displayLineChart(e);let t=e.reverse()[0];await displayMedia(e),displayPieChart(t),displayLastRecord(t)}async function requestNotifications(){try{await messaging.requestPermission();const e=await messaging.getToken();localStorage.setItem("covid-token",e);let t=await postData(`${server}/subscribe`,{token:e});console.log(e,t),toast("Notifications Enabled!")}catch(e){console.error(e)}}async function tokenRefresh(){try{const e=await messaging.getToken();localStorage.set("covid-token",e)}catch(e){console.log("Unable to retrieve refreshed token ",err)}}async function deleteToken(){const e=await messaging.getToken();messaging.deleteToken(e),localStorage.removeItem("covid-token"),toast("Notifications Disabled!")}function toggleMsg(e){e.target.checked?requestNotifications():deleteToken()}async function checkAlertStatus(){document.querySelector("#msgEnabled").checked=null!==localStorage.getItem("covid-token")}async function foregroundMsg(e){console.log("Foreground Message: ",e)}function login(e){ui.start("#authContainer",{callbacks:{signInSuccessWithAuthResult:function(e,t){auth=e,loginModal.close()}},signInFlow:"popup",signInSuccessUrl:"#",signInOptions:[firebase.auth.GoogleAuthProvider.PROVIDER_ID],tosUrl:"https://covid19tt.web.app",privacyPolicyUrl:"https://covid19tt.web.app"})}async function logout(){let e=await firebase.auth().signOut();console.log(e),toast("Logged Out!")}function getAuth(){const e=document.querySelector("#addFab"),t=document.querySelector("#loginBtn"),o=document.querySelector("#logoutBtn"),n=document.querySelectorAll(".deleteBtn");firebase.auth().onAuthStateChanged(function(a){a?(auth=a,e.style.display="block",t.style.display="none",o.style.display="block",n.forEach(e=>e.style.display="block")):(auth=void 0,e.style.display="none",t.style.display="block",o.style.display="none",n.forEach(e=>e.style.display="none"))})}function toast(e){M.toast({html:e})}function monitorCollection(){releasesRef.onSnapshot(e=>{records=[],e.forEach(e=>{records.push(e.data())}),displayData(records)})}async function main(){(messaging=firebase.messaging()).usePublicVapidKey("BAqoB57ExCmPU2hHer0NWSqTsHgAABG78b0IB_KkAqfAg63k9MG8Q8vqXETs0wDcBckFbsTUs191L39nW7M-EsU"),messaging.onTokenRefresh(tokenRefresh),messaging.onMessage(foregroundMsg),document.querySelector("#msgEnabled").addEventListener("click",toggleMsg),document.querySelector("#loginBtn").addEventListener("click",login),document.querySelector("#logoutBtn").addEventListener("click",logout),document.forms.createForm.addEventListener("submit",createReport);const e=await releasesRef.get();let t=[];e.forEach(e=>{t.push(e.data())}),displayData(t),getAuth(),monitorCollection(),fixAccessbility(),registerSW(),checkAlertStatus()}addModal=M.Modal.init(document.querySelector("#addModal")),deleteModal=M.Modal.init(document.querySelector("#deleteModal"),{onOpenStart:function(){document.querySelector("#selected").innerHTML=selected}}),loginModal=M.Modal.init(document.querySelector("#loginModal"),{onOpenStart:login}),M.Tabs.init(document.querySelector(".tabs")),window.addEventListener("load",main);