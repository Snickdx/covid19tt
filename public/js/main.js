import{toggleMsg,tokenRefresh,checkAlertStatus,foregroundMsg,registerSW}from"./notification.js";import{logout,getUser,handleAuthChange}from"./auth.js";import{displayData,monitorCollection}from"./display.js";function fixAccessbility(){let e=document.querySelector(".highslide-container>img");e.setAttribute("alt","highslide container image"),e.setAttribute("aria-hidden",!0)}async function createReport(e,t){e.preventDefault();let o=e.target.elements,a={id:parseInt(o.updateNum.value),url:o.url.value,date:Math.floor(new Date(o.date.value).getTime()/1e3),cases:{deaths:parseInt(o.deaths.value),positive:parseInt(o.positive.value),discharged:parseInt(o.discharged.value)},notify:"on"===o.notify.value,tested:parseInt(o.tested.value)};try{await t.doc(""+a.id).set(a);toast("Report Added!")}catch(e){toast("Error: Insufficient Permissions")}}async function getData(e){const t=await e.get();let o=[];return t.forEach(e=>{o.push(e.data())}),o}async function deleteData(e){try{const t=await db.collection("releases").doc(""+e).delete();console.log(e,t),toast("Report Deleted!")}catch(e){toast("Error: Insufficient Permissions"),console.log(e)}}function toast(e){M.toast({html:e})}async function main(){const e=firebase.firestore(),t=firebase.auth(),o=firebase.messaging();o.usePublicVapidKey("BAqoB57ExCmPU2hHer0NWSqTsHgAABG78b0IB_KkAqfAg63k9MG8Q8vqXETs0wDcBckFbsTUs191L39nW7M-EsU"),o.onTokenRefresh(()=>tokenRefresh(o)),o.onMessage(foregroundMsg,toast);const a=new firebaseui.auth.AuthUI(t);console.log(a.start);const s=e.collection("releases");let n=await getData(s),i=await getUser(t);M.Modal.init(document.querySelector("#addModal"));const r=M.Modal.init(document.querySelector("#loginModal"),{onOpenStart:login});M.Tabs.init(document.querySelector(".tabs"));document.querySelector("#msgEnabled").addEventListener("click",e=>toggleMsg(e,o)),document.querySelector("#loginBtn").addEventListener("click",e=>{a.start("#authContainer",{callbacks:{signInSuccessWithAuthResult:e=>{i=e,r.close()}},signInFlow:"popup",signInSuccessUrl:"#",signInOptions:[firebase.auth.GoogleAuthProvider.PROVIDER_ID],tosUrl:"https://covid19tt.web.app",privacyPolicyUrl:"https://covid19tt.web.app"})}),document.querySelector("#logoutBtn").addEventListener("click",()=>logout(t,toast)),document.forms.createForm.addEventListener("submit",e=>createReport(e,s)),handleAuthChange(t),displayData(n,i),monitorCollection(s,i),fixAccessbility(),checkAlertStatus()}window.addEventListener("load",main);